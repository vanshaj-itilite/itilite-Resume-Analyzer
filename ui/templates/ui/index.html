<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resume Analyzer | AI Hiring Workspace</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'ui/styles.css' %}" />
</head>
<body data-backend-url="{{ backend_url }}">
  <div class="shell">
    <nav class="site-nav">
      <div class="nav-inner">
        <div class="brand">itilite <span>Resume Analyzer</span></div>
        <div class="nav-links">
          <a class="nav-link" href="#workspace">Workspace</a>
          <a class="nav-link" href="/how_to_use/">How To Use</a>
          <a class="nav-link" href="/technical_docs/">Docs</a>
          <a class="nav-link" href="/analytics/">Analytics</a>
          <button type="button" class="btn ghost" id="openSettings">Global AI Settings</button>
        </div>
      </div>
    </nav>

    <section class="hero">
      <article class="hero-card">
        <div class="eyebrow">Orange. Gray. White. Precision Hiring.</div>
        <h1>Full Hiring Intelligence, From Resume to Decision</h1>
        <p class="sub">Run semantic, technical, and psychometric analysis in single or batch mode with centralized AI controls.</p>
        <div class="hero-cta">
          <a class="btn" href="#workspace">Start Analysis</a>
          <a class="btn ghost" href="/technical_docs/">Read Technical Docs</a>
        </div>
      </article>
      <aside class="hero-side">
        <div>
          <div class="stat"><span>Parallel Upload Pipeline</span><strong>Batch Ready</strong></div>
          <div class="stat"><span>Scoring Threshold Control</span><strong>Configurable</strong></div>
        </div>
        <p class="sub">Built for recruiter workflows and fast shortlist decisions.</p>
      </aside>
    </section>

    <section class="section-grid">
      <a class="section-card" href="/analytics/"><strong>Analytics Dashboard</strong><p>Track score trends and response quality.</p></a>
      <a class="section-card" href="/how_to_use/"><strong>Usage Guide</strong><p>Quick-start flow and expected input formats.</p></a>
      <a class="section-card" href="/technical_docs/"><strong>Technical Docs</strong><p>Model behavior, API flow, and architecture notes.</p></a>
    </section>

    {% if error %}
      <div class="card error" style="border-left: 4px solid #ef4444;">
        <strong>Analysis Error:</strong> {{ error }}
      </div>
    {% endif %}

    <form id="workspace" class="grid-layout" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <aside class="side-col">
        <section class="card settings-card">
          <div class="card-header">
            <h2>Job Context</h2>
            <p class="sub">Provide role details for better ranking quality.</p>
          </div>

          <div class="stack">
            <label class="field">
              <span>Company Name</span>
              {{ form.company_name }}
            </label>

            <label class="field">
              <span>Role</span>
              {{ form.role }}
            </label>

            <label class="field">
              <span>Experience Level (Years)</span>
              <div class="range-container">
                {{ form.experience_level }}
                <output id="experienceValue">3</output>
              </div>
            </label>

            <label class="field">
              <span>Job Description</span>
              {{ form.job_description }}
            </label>

            <label class="field">
              <span>Skills</span>
              {{ form.jd_prompt }}
              <p class="hint" id="jdPromptPreview"></p>
            </label>
          </div>

          <p class="hint">Batch processing is optimized for multi-resume runs.</p>
        </section>
      </aside>

      <main class="main-col">
        <div id="settingsModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
          <div class="modal-backdrop" data-close-settings></div>
          <div class="modal-panel card settings-card">
            <div class="modal-header-row">
              <div class="card-header">
                <h2 id="settingsTitle">Global AI Settings</h2>
                <p class="sub">These apply to single and batch analysis.</p>
              </div>
              <button type="button" class="btn ghost modal-close" data-close-settings>&times;</button>
            </div>
            <div class="stack">
              <label class="field">
                <span>Model Provider</span>
                {{ form.provider }}
              </label>
              <label class="field">
                <span>Intelligence Model</span>
                {{ form.ai_model }}
              </label>
              <label class="field">
                <span>Temperature (Creativity)</span>
                {{ form.temperature }}
              </label>
              <label class="field">
                <span>Confidence Threshold</span>
                <div class="range-container">
                  {{ form.threshold }}
                  <output id="thresholdValue">50</output>
                </div>
              </label>
            </div>
            <div class="actions">
              <button class="btn" type="button" id="saveAiSettings" data-loading-text="Saving...">
                <span class="btn-label">Save AI Settings</span>
                <span class="btn-spinner" aria-hidden="true"></span>
              </button>
              <span class="hint" id="aiSettingsStatus">Not saved</span>
            </div>
          </div>
        </div>

        <div class="mode-toggle">
          <button type="button" class="mode-btn active" data-mode="single">Single Analysis</button>
          <button type="button" class="mode-btn" data-mode="batch">Batch Upload</button>
        </div>

        <div id="singleSection" class="input-mode">
          <section class="card">
            <div class="card-header">
              <h2>Single Resume Analysis</h2>
              <p class="sub">Paste resume text and run one-shot evaluation.</p>
            </div>
            <label class="field">{{ form.document_text }}</label>
            <button class="btn primary-btn" type="submit" data-loading-text="Running...">
              <span class="btn-label">Run Single Analysis</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </section>
        </div>

        <div id="batchSection" class="input-mode hidden">
          <section class="card">
            <div class="card-header">
              <h2>Batch Processing</h2>
              <p class="sub">Upload multiple PDF resumes or an entire folder.</p>
            </div>

            <div class="upload-grid">
              <label class="upload-dropzone">
                <span class="upload-visual single" aria-hidden="true"></span>
                <span class="upload-title">Upload Files</span>
                <span class="upload-desc">Use this for single or multiple PDFs.</span>
                <input id="batchFiles" type="file" multiple accept=".pdf" />
              </label>
              <label class="upload-dropzone">
                <span class="upload-visual folder" aria-hidden="true"></span>
                <span class="upload-title">Upload Folder</span>
                <span class="upload-desc">Select a full folder of resumes.</span>
                <input id="batchFolder" type="file" webkitdirectory directory />
              </label>
            </div>

            <div class="actions">
              <button class="btn" type="button" id="batchRun" data-loading-text="Processing...">
                <span class="btn-label">Run Batch Analysis</span>
                <span class="btn-spinner" aria-hidden="true"></span>
              </button>
              <button class="btn ghost" type="button" id="batchClear">Clear Queue</button>
            </div>

            <div class="progress-bar-bg"><div class="progress-bar-fill" id="batchProgress"></div></div>
            <div class="status-legend">
              <span class="legend-item">Queued</span>
              <span class="legend-item">Running</span>
              <span class="legend-item">Complete</span>
            </div>
            <div id="batchStatus" class="status-list"></div>
          </section>
        </div>

        {% if result or resume_data %}
          <section class="card results-card">
            <div class="card-header">
              <h2>Latest Result</h2>
              <p class="sub">Most recent score and generated summary.</p>
            </div>
            {% if result %}
              <div class="result-grid">
                <div class="stat-card">
                  <h3>Score</h3>
                  <div class="stat-value">{{ result.score }}</div>
                </div>
                <div class="stat-card">
                  <h3>Summary</h3>
                  <p class="result-text">{{ result.summary }}</p>
                </div>
              </div>
            {% else %}
              <p class="result-text">No result available.</p>
            {% endif %}
          </section>
        {% endif %}
      </main>
    </form>
  </div>

  {% include "ui/footer.html" %}

  {{ ai_model_providers|json_script:"providerModelsData" }}

  <script>
    const providerModels = JSON.parse(
      document.getElementById("providerModelsData")?.textContent || "{}"
    );
    document.querySelectorAll('.mode-btn').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const mode = this.dataset.mode;
        if (mode === 'single') {
          document.getElementById('singleSection').classList.remove('hidden');
          document.getElementById('batchSection').classList.add('hidden');
        } else {
          document.getElementById('singleSection').classList.add('hidden');
          document.getElementById('batchSection').classList.remove('hidden');
        }
      });
    });

    const thresholdInput = document.querySelector('input[name="threshold"]');
    if (thresholdInput) {
      thresholdInput.addEventListener('input', (e) => {
        document.getElementById('thresholdValue').textContent = e.target.value;
      });
    }

    const slider = document.querySelector('input[name="threshold"]');
    const output = document.getElementById('thresholdValue');
    if (slider && output) {
      output.textContent = slider.value;
      slider.addEventListener('input', (e) => {
        output.textContent = e.target.value;
      });
    }

    const experienceSlider = document.querySelector('input[name="experience_level"]');
    const experienceOutput = document.getElementById('experienceValue');
    if (experienceSlider && experienceOutput) {
      experienceOutput.textContent = experienceSlider.value;
      experienceSlider.addEventListener('input', (e) => {
        experienceOutput.textContent = e.target.value;
      });
    }

    const form = document.querySelector('form.grid-layout');

    const linkButtons = document.querySelectorAll('a.btn[data-loading-text]');
    linkButtons.forEach((link) => {
      link.addEventListener('click', () => {
        link.classList.add('is-loading');
        link.setAttribute('aria-busy', 'true');
        const label = link.querySelector('.btn-label');
        const loadingText = link.getAttribute('data-loading-text');
        if (label && loadingText) {
          label.textContent = loadingText;
        }
      });
    });

    const backendUrl = document.body.dataset.backendUrl || "http://localhost:8001";
    const batchFilesInput = document.getElementById("batchFiles");
    const batchFolderInput = document.getElementById("batchFolder");
    const batchRun = document.getElementById("batchRun");
    const batchClear = document.getElementById("batchClear");
    const batchProgress = document.getElementById("batchProgress");
    const batchStatus = document.getElementById("batchStatus");
    const saveAiSettingsButton = document.getElementById("saveAiSettings");
    const aiSettingsStatus = document.getElementById("aiSettingsStatus");

    const uploadState = new Map();
    let savedAiSettings = null;
    let settingsDirty = false;

    const providerSelect = document.querySelector('select[name="provider"]');
    const modelSelect = document.querySelector('select[name="ai_model"]');
    const tempInputEl = document.querySelector('input[name="temperature"]');
    const thresholdInputEl = document.querySelector('input[name="threshold"]');
    const settingsModal = document.getElementById("settingsModal");
    const openSettingsButton = document.getElementById("openSettings");

    const setRunEnabled = (enabled) => {
      if (batchRun) batchRun.disabled = !enabled;
      const submitBtn = form?.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = !enabled;
    };

    const markSettingsDirty = () => {
      settingsDirty = true;
      if (aiSettingsStatus) aiSettingsStatus.textContent = "Not saved";
      setRunEnabled(false);
    };

    const markSettingsSaved = () => {
      settingsDirty = false;
      if (aiSettingsStatus) aiSettingsStatus.textContent = "Saved";
      setRunEnabled(true);
    };

    const renderModelOptions = (provider) => {
      if (!modelSelect) return;
      const models = providerModels[provider] || providerModels.groq || [];
      modelSelect.innerHTML = "";
      models.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item[0];
        opt.textContent = item[1];
        modelSelect.appendChild(opt);
      });
      modelSelect.value = models[0]?.[0] || "";
    };

    if (providerSelect) {
      renderModelOptions(providerSelect.value || "groq");
      providerSelect.addEventListener("change", (e) => {
        renderModelOptions(e.target.value);
        markSettingsDirty();
      });
    }

    const formatBytes = (bytes) => {
      if (!bytes && bytes !== 0) return "";
      const units = ["B", "KB", "MB", "GB"];
      let value = bytes;
      let idx = 0;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx += 1;
      }
      return `${value.toFixed(value < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
    };

    const collectFiles = () => {
      const files = [];
      if (batchFilesInput?.files?.length) files.push(...batchFilesInput.files);
      if (batchFolderInput?.files?.length) files.push(...batchFolderInput.files);
      const seen = new Set();
      return files.filter((file) => {
        const pathName = file.webkitRelativePath || file.name;
        const key = `${pathName}-${file.size}-${file.lastModified}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    };

    const resetBatchUI = () => {
      uploadState.clear();
      if (batchStatus) batchStatus.innerHTML = "";
      if (batchProgress) batchProgress.style.width = "0%";
      if (batchFilesInput) batchFilesInput.value = "";
      if (batchFolderInput) batchFolderInput.value = "";
    };

    const createStatusRow = (file) => {
      const pathName = file.webkitRelativePath || file.name;
      const key = `${pathName}-${file.size}-${file.lastModified}`;
      const row = document.createElement("div");
      row.className = "status-row";
      row.dataset.filename = pathName;
      row.dataset.key = key;
      row.innerHTML = `
        <div class="status-name">
          <span class="status-icon" aria-hidden="true"></span>
          <span class="status-filename">${pathName}</span>
        </div>
        <div class="status-meta">${formatBytes(file.size)}</div>
        <div class="status-state">Queued</div>
        <div class="status-summary"></div>
        <div class="status-track">
          <div class="status-track-bar"><div class="status-progress"></div></div>
          <span class="status-progress-text">0%</span>
        </div>
      `;
      batchStatus?.appendChild(row);
      return row;
    };

    const updateOverallProgress = () => {
      let loaded = 0;
      let total = 0;
      uploadState.forEach((entry) => {
        loaded += entry.loaded || 0;
        total += entry.total || 0;
      });
      const pct = total ? Math.round((loaded / total) * 100) : 0;
      if (batchProgress) batchProgress.style.width = `${pct}%`;
    };

    const getThresholdValue = () => {
      const t = document.querySelector('input[name="threshold"]');
      if (!t) return 0;
      const v = parseInt(t.value, 10);
      return Number.isFinite(v) ? v : 0;
    };

    const setStatusIcon = (row, passed) => {
      const icon = row.querySelector(".status-icon");
      if (!icon) return;
      icon.classList.remove("pass", "fail");
      if (passed === true) icon.classList.add("pass");
      if (passed === false) icon.classList.add("fail");
    };

    const pollStatus = (taskId, row) => {
      fetch(`${backendUrl}/analysis/status/${taskId}`, { credentials: "omit" })
        .then((resp) => resp.json())
        .then((data) => {
          const state = data.state || "PENDING";
          const stateEl = row.querySelector(".status-state");
          const summaryEl = row.querySelector(".status-summary");
          const progressEl = row.querySelector(".status-progress");
          const progressText = row.querySelector(".status-progress-text");

          if (stateEl) {
            if (state === "SUCCESS") stateEl.textContent = "Complete";
            else if (state === "FAILURE") stateEl.textContent = "Failed";
            else if (state === "STARTED") stateEl.textContent = "Running";
            else stateEl.textContent = "Queued";
          }

          if (typeof data.progress === "number") {
            const pct = Math.max(0, Math.min(100, data.progress));
            if (progressEl) progressEl.style.width = `${pct}%`;
            if (progressText) progressText.textContent = `${pct}%`;
          }

          if (state === "SUCCESS") {
            const score = Number(data?.result?.score);
            const threshold = getThresholdValue();
            setStatusIcon(row, Number.isFinite(score) ? score >= threshold : null);
            if (summaryEl) summaryEl.textContent = data?.result?.summary || "";
            return;
          }
          if (state === "FAILURE") {
            setStatusIcon(row, false);
            if (summaryEl) summaryEl.textContent = "Failed to generate report.";
            return;
          }
          setTimeout(() => pollStatus(taskId, row), 2000);
        })
        .catch(() => setTimeout(() => pollStatus(taskId, row), 4000));
    };

    const uploadFile = (file, row) =>
      new Promise((resolve) => {
        const request = new XMLHttpRequest();
        const formData = new FormData();
        formData.append("file", file, file.name);

        const aiModel = savedAiSettings?.ai_model || "";
        const temperature = savedAiSettings?.temperature || "";
        const threshold = savedAiSettings?.threshold || "";
        const companyName = document.querySelector('input[name="company_name"]')?.value || "";
        const role = document.querySelector('select[name="role"]')?.value || "";
        const experienceLevel = document.querySelector('input[name="experience_level"]')?.value || "";
        const jobDescription = document.querySelector('textarea[name="job_description"]')?.value || "";
        const jdPrompt = buildFinalPrompt();

        if (aiModel) formData.append("ai_model", aiModel);
        if (temperature) formData.append("temperature", temperature);
        if (threshold) formData.append("threshold", threshold);
        if (companyName) formData.append("company_name", companyName);
        if (role) formData.append("role", role);
        if (experienceLevel !== "") formData.append("experience_level", experienceLevel);
        if (jobDescription) formData.append("job_description", jobDescription);
        if (jdPrompt) formData.append("jd_prompt", jdPrompt);

        request.upload.addEventListener("progress", (event) => {
          if (!event.lengthComputable) return;
          uploadState.set(row.dataset.key, { loaded: event.loaded, total: event.total });
          updateOverallProgress();
          const meta = row.querySelector(".status-meta");
          if (meta) {
            const pct = Math.round((event.loaded / event.total) * 100);
            meta.textContent = `${pct}% uploaded`;
          }
        });

        request.onreadystatechange = () => {
          if (request.readyState !== 4) return;
          const stateEl = row.querySelector(".status-state");
          const summaryEl = row.querySelector(".status-summary");
          if (request.status >= 200 && request.status < 300) {
            const resp = JSON.parse(request.responseText || "{}");
            if (stateEl) stateEl.textContent = "Queued";
            if (resp.task_id) {
              row.dataset.taskId = resp.task_id;
              pollStatus(resp.task_id, row);
            }
          } else {
            if (stateEl) stateEl.textContent = "Upload failed";
            let detail = request.responseText || "";
            try { detail = JSON.parse(detail).detail || detail; } catch (_) {}
            if (summaryEl) summaryEl.textContent = detail || "Upload failed.";
          }
          resolve();
        };

        request.open("POST", `${backendUrl}/analysis/async`);
        request.send(formData);
      });

    if (batchRun) {
      batchRun.addEventListener("click", async () => {
        if (settingsDirty) {
          if (aiSettingsStatus) aiSettingsStatus.textContent = "Save settings first";
          return;
        }

        const files = collectFiles().filter((file) => file.name.toLowerCase().endsWith(".pdf"));
        if (!files.length) {
          alert("Select at least one PDF file to upload.");
          return;
        }

        batchRun.classList.add("is-loading");
        batchRun.disabled = true;
        const label = batchRun.querySelector(".btn-label");
        const loadingText = batchRun.getAttribute("data-loading-text");
        if (label && loadingText) label.textContent = loadingText;

        files.forEach((file) => {
          const pathName = file.webkitRelativePath || file.name;
          const key = `${pathName}-${file.size}-${file.lastModified}`;
          uploadState.set(key, { loaded: 0, total: file.size });
        });
        updateOverallProgress();

        await Promise.all(files.map((file) => uploadFile(file, createStatusRow(file))));

        batchRun.classList.remove("is-loading");
        batchRun.disabled = false;
        if (label) label.textContent = "Run Batch";
      });
    }

    if (batchClear) batchClear.addEventListener("click", resetBatchUI);

    const roleEl = document.querySelector('select[name="role"]');
    const jobDescriptionEl = document.querySelector('textarea[name="job_description"]');
    const jdPromptEl = document.querySelector('textarea[name="jd_prompt"]');
    const jdPromptPreview = document.getElementById("jdPromptPreview");

    const buildFinalPrompt = () => {
      const role = roleEl?.value || "";
      const jd = jobDescriptionEl?.value || "";
      const userPrompt = jdPromptEl?.value || "";
      const parts = [];
      if (role) parts.push(`Role: ${role}`);
      if (userPrompt) parts.push(`Skills:\n${userPrompt}`);
      if (jd) parts.push(`Job Description:\n${jd}`);
      return parts.join("\n\n");
    };

    const renderFinalPrompt = () => {
      const rendered = buildFinalPrompt();
      if (jdPromptPreview) jdPromptPreview.textContent = rendered ? `Preview:\n${rendered}` : "";
    };

    if (roleEl) roleEl.addEventListener("change", renderFinalPrompt);
    if (jobDescriptionEl) jobDescriptionEl.addEventListener("input", renderFinalPrompt);
    if (jdPromptEl) jdPromptEl.addEventListener("input", renderFinalPrompt);
    renderFinalPrompt();

    if (saveAiSettingsButton) {
      saveAiSettingsButton.addEventListener("click", () => {
        saveAiSettingsButton.classList.add("is-loading");
        saveAiSettingsButton.setAttribute("aria-busy", "true");
        const label = saveAiSettingsButton.querySelector(".btn-label");
        const loadingText = saveAiSettingsButton.getAttribute("data-loading-text");
        if (label && loadingText) label.textContent = loadingText;

        const provider = providerSelect?.value || "groq";
        const aiModel = modelSelect?.value || "";
        const temperature = tempInputEl?.value || "";
        const threshold = thresholdInputEl?.value || "";
        savedAiSettings = { provider, ai_model: aiModel, temperature, threshold };

        setTimeout(() => {
          saveAiSettingsButton.classList.remove("is-loading");
          saveAiSettingsButton.removeAttribute("aria-busy");
          if (label) label.textContent = "Save AI Settings";
          markSettingsSaved();
        }, 300);
      });
    }

    const closeSettings = () => {
      if (!settingsModal) return;
      settingsModal.classList.add("hidden");
      settingsModal.setAttribute("aria-hidden", "true");
    };

    if (openSettingsButton && settingsModal) {
      openSettingsButton.addEventListener("click", () => {
        settingsModal.classList.remove("hidden");
        settingsModal.setAttribute("aria-hidden", "false");
      });
    }

    document.querySelectorAll("[data-close-settings]").forEach((el) => {
      el.addEventListener("click", closeSettings);
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeSettings();
    });

    if (form) {
      form.addEventListener('submit', (e) => {
        if (settingsDirty) {
          e.preventDefault();
          if (aiSettingsStatus) aiSettingsStatus.textContent = "Save settings first";
          return;
        }

        const button = form.querySelector('button[type="submit"]');
        if (button) {
          button.classList.add('is-loading');
          button.disabled = true;
          const label = button.querySelector('.btn-label');
          const loadingText = button.getAttribute('data-loading-text');
          if (label && loadingText) label.textContent = loadingText;
        }

        if (providerSelect) providerSelect.value = savedAiSettings?.provider || "groq";
        if (modelSelect) modelSelect.value = savedAiSettings?.ai_model || "";
        if (tempInputEl) tempInputEl.value = savedAiSettings?.temperature || "";
        if (thresholdInputEl) thresholdInputEl.value = savedAiSettings?.threshold || "";
        if (jdPromptEl) jdPromptEl.value = buildFinalPrompt();
      });
    }

    if (modelSelect) modelSelect.addEventListener("change", markSettingsDirty);
    if (tempInputEl) tempInputEl.addEventListener("input", markSettingsDirty);
    if (thresholdInputEl) thresholdInputEl.addEventListener("input", markSettingsDirty);

    savedAiSettings = {
      provider: providerSelect?.value || "groq",
      ai_model: modelSelect?.value || "",
      temperature: tempInputEl?.value || "",
      threshold: thresholdInputEl?.value || ""
    };
    markSettingsSaved();
  </script>
</body>
</html>



