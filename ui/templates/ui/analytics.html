<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics | Resume Analyzer</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'ui/styles.css' %}" />
</head>
<body>
  <div class="shell">
    <nav class="site-nav">
      <div class="nav-inner">
        <div class="brand">itilite <span>Resume Analyzer</span></div>
        <div class="nav-links">
          <a class="nav-link" href="/">Workspace</a>
          <a class="nav-link" href="/how_to_use/">How To Use</a>
          <a class="nav-link" href="/technical_docs/">Docs</a>
          <a class="nav-link" href="/analytics/">Analytics</a>
        </div>
      </div>
    </nav>

    <header class="hero-card page-hero">
      <p class="eyebrow">Analytics</p>
      <h1>Processing History</h1>
      <p class="sub">Review the latest runs and sort by score quickly.</p>
    </header>

    <section class="card">
      <div class="table-controls">
        <label class="field compact">
          <span>Sort by score</span>
          <select id="scoreSort" aria-label="Sort analytics by score">
            <option value="desc">Score: High to Low</option>
            <option value="asc">Score: Low to High</option>
            <option value="default">Latest first</option>
          </select>
        </label>
      </div>

      <div class="table analytics-table">
        <div class="row header">
          <div>Timestamp</div>
          <div>Score/PDF</div>
          <div>Summary</div>
          <div>Threshold</div>
          <div>Provider/Model/Temp</div>
        </div>

        {% for r in runs %}
          <div class="row" data-score="{{ r.score|default:'' }}" data-index="{{ forloop.counter0 }}">
            <div class="text-accent mono">{{ r.created_at|date:"Y-m-d H:i" }}</div>
            <div class="text-muted">
              <span class="text-accent">{{ r.score|default:"-" }}</span>
              {% if r.file_name %}
                <span class="text-muted"> - {{ r.file_name }}</span>
              {% endif %}
            </div>
            <div class="text-muted summary-cell">{{ r.summary|default:"-" }}</div>
            <div>{{ r.threshold }}%</div>
            <div class="text-muted">{{ r.provider|default:"-" }} / {{ r.ai_model|default:"-" }} / {{ r.temperature|default:"-" }}</div>
          </div>
        {% empty %}
          <div class="row empty"><p>No analysis logs found.</p></div>
        {% endfor %}
      </div>
    </section>
  </div>

  {% include "ui/footer.html" %}

  <script>
    const scoreSort = document.getElementById("scoreSort");
    const table = document.querySelector(".table");

    function sortRows(mode) {
      if (!table) return;
      const rows = Array.from(table.querySelectorAll(".row")).filter((row) => !row.classList.contains("header") && !row.classList.contains("empty"));
      if (rows.length === 0) return;

      const sorted = rows.slice().sort((a, b) => {
        if (mode === "default") {
          return Number(a.dataset.index || 0) - Number(b.dataset.index || 0);
        }
        const aScore = parseFloat(a.dataset.score);
        const bScore = parseFloat(b.dataset.score);
        const aVal = Number.isFinite(aScore) ? aScore : -1;
        const bVal = Number.isFinite(bScore) ? bScore : -1;
        return mode === "asc" ? aVal - bVal : bVal - aVal;
      });

      sorted.forEach((row) => table.appendChild(row));
    }

    if (scoreSort) {
      sortRows(scoreSort.value || "desc");
      scoreSort.addEventListener("change", (event) => sortRows(event.target.value));
    }
  </script>
</body>
</html>
